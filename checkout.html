<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Оформление заказа</title>
    <link rel="stylesheet" href="assets/css/reset.css">
    <link rel="stylesheet" href="assets/css/style.css">
    <script src="https://api-maps.yandex.ru/2.1/?apikey=aa9feae8-022d-44d2-acb1-8cc0198f451d&lang=ru_RU" type="text/javascript"></script>
</head>
<body>
    <header class="header">
        <div class="header__container">
            <button class="header__burger" id="mobileMenuToggle">
                <span></span>
                <span></span>
                <span></span>
            </button>
            
            <nav class="header__nav">
                <ul class="header__menu">
                    <li class="header__item">
                        <a href="#" class="header__link">О компании</a>
                    </li>
                    <li class="header__item">
                        <a href="#" class="header__link">Каталог</a>
                    </li>
                    <li class="header__item">
                        <a href="#" class="header__link">Связаться с нами</a>
                    </li>
                </ul>
            </nav>
            
            <div class="header__actions">
                <button class="header__button header__button--login">Войти</button>
                <button class="header__button header__button--cart">
                    <img src="/assets/img/cart.svg" alt="">
                    <span class="header__cart-count" id="cartCount">3</span>
                </button>
            </div>
        </div>
        
        <!-- Мобильное меню -->
        <div class="mobile-menu" id="mobileMenu">
            <div class="mobile-menu__overlay"></div>
            <div class="mobile-menu__content">
                <button class="mobile-menu__close" id="mobileMenuClose">×</button>
                <nav class="mobile-menu__nav">
                    <ul class="mobile-menu__list">
                        <li class="mobile-menu__item">
                            <a href="#" class="mobile-menu__link">О компании</a>
                        </li>
                        <li class="mobile-menu__item">
                            <a href="#" class="mobile-menu__link">Каталог</a>
                        </li>
                        <li class="mobile-menu__item">
                            <a href="#" class="mobile-menu__link">Связаться с нами</a>
                        </li>
                    </ul>
                </nav>
                <div class="mobile-menu__actions">
                    <button class="mobile-menu__button mobile-menu__button--login">Войти</button>
                    <button class="mobile-menu__button mobile-menu__button--cart">
                        Корзина
                        <span class="mobile-menu__cart-count" id="mobileCartCount">3</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="checkout">
        <div class="checkout__container">
            <h1 class="checkout__title">Оформление заказа</h1>
            <a href="#" class="checkout__edit-link">Редактировать заказ</a>

            <!-- Товары в заказе -->
            <div class="checkout__items">
                <div class="checkout__item">
                    <img src="assets/img/macaron-1.png" alt="Макаронс Фисташка - Малина" class="checkout__item-image">
                    <h3 class="checkout__item-title">Макаронс Фисташка - Малина</h3>
                    <div class="checkout__item-info">12 400 KZT x 1 ед.</div>
                    <div class="checkout__item-total">12 400 KZT</div>
                </div>
                
                <div class="checkout__item">
                    <img src="assets/img/macaron-1.png" alt="Макаронс Фисташка - Малина" class="checkout__item-image">
                    <h3 class="checkout__item-title">Макаронс Фисташка - Малина</h3>
                    <div class="checkout__item-info">12 400 KZT x 1 ед.</div>
                    <div class="checkout__item-total">12 400 KZT</div>
                </div>
                
                <div class="checkout__item">
                    <img src="assets/img/macaron-1.png" alt="Макаронс Фисташка - Малина" class="checkout__item-image">
                    <h3 class="checkout__item-title">Макаронс Фисташка - Малина</h3>
                    <div class="checkout__item-info">12 400 KZT x 1 ед.</div>
                    <div class="checkout__item-total">12 400 KZT</div>
                </div>
            </div>

            <div class="checkout__promo">
                <a href="#" class="checkout__promo-link" id="openPromoPopup">Промокод +</a>
                <div class="checkout__total">
                    <span class="checkout__total-text">К оплате:</span>
                    <span class="checkout__total-price" id="totalPrice">377 200 KZT</span>
                </div>
            </div>

            <!-- Доставка -->
            <div class="checkout__section">
                <h2 class="checkout__section-title">Доставка</h2>
                
                <div class="checkout__option">
                    <label class="checkout__option-label">
                        <input type="radio" name="delivery" value="pickup" checked>
                        <span class="checkout__option-checkbox"></span>
                        <span class="checkout__option-text">Самовывоз из нашего магазина (с 9 до 22)</span>
                        <span class="checkout__option-price">Бесплатно</span>
                    </label>
                    
                    <!-- Детали для самовывоза -->
                    <div class="checkout__option-details" id="pickupDetails">
                        <div class="checkout__option-address">
                            <input type="text" value="Астана. Проспект Улы Дала 45/1" class="checkout__option-input">
                            <img src="assets/img/location-icon.svg" alt="Локация" class="checkout__option-icon">
                        </div>
                        <button class="checkout__option-map-btn" id="openMapPopup">Выбрать на карте</button>
                    </div>
                </div>

                <div class="checkout__option">
                    <label class="checkout__option-label">
                        <input type="radio" name="delivery" value="delivery">
                        <span class="checkout__option-checkbox"></span>
                        <span class="checkout__option-text">Доставка на адрес (в течении 1 часа)</span>
                        <span class="checkout__option-price">990 KZT</span>
                    </label>
                    
                    <!-- Детали для доставки -->
                    <div class="checkout__option-details" id="deliveryDetails" style="display: none;">
                        <div class="checkout__option-time-info">Утро, день, вечер, 9-12, 12-15 (как в каспи магнум)</div>
                        <div class="checkout__option-address">
                            <input type="text" value="Астана. Проспект Улы Дала 45/1" class="checkout__option-input">
                            <img src="assets/img/location-icon.svg" alt="Локация" class="checkout__option-icon">
                        </div>
                        <button class="checkout__option-map-btn" id="openMapPopup2">Выбрать на карте</button>
                    </div>
                </div>
            </div>

            <!-- Оплата -->
            <div class="checkout__section">
                <h2 class="checkout__section-title">Оплата</h2>
                
                <div class="checkout__option">
                    <label class="checkout__option-label">
                        <input type="radio" name="payment" value="on-receipt" checked>
                        <span class="checkout__option-checkbox"></span>
                        <span class="checkout__option-text">Оплата во время получения заказа</span>
                    </label>
                </div>

                <div class="checkout__option">
                    <label class="checkout__option-label">
                        <input type="radio" name="payment" value="now">
                        <span class="checkout__option-checkbox"></span>
                        <span class="checkout__option-text">Оплатить сейчас</span>
                    </label>
                    
                    <!-- Подварианты для "Оплатить сейчас" -->
                    <div class="checkout__option-details" id="paymentNowDetails" style="display: none;">
                        <div class="checkout__payment-methods">
                            <label class="checkout__payment-method">
                                <input type="radio" name="payment-method" value="kaspi">
                                <span class="checkout__payment-checkbox"></span>
                                <span class="checkout__payment-text">Каспи</span>
                                <span class="checkout__payment-icon"><img src="/assets/img/payment_1.svg" alt=""></span>
                            </label>
                            
                            <label class="checkout__payment-method">
                                <input type="radio" name="payment-method" value="bank-card">
                                <span class="checkout__payment-checkbox"></span>
                                <span class="checkout__payment-text">Карта банка</span>
                                <span class="checkout__payment-icon"><img src="/assets/img/payment_2.svg" alt=""></span>
                            </label>
                            
                            <label class="checkout__payment-method">
                                <input type="radio" name="payment-method" value="google-pay">
                                <span class="checkout__payment-checkbox"></span>
                                <span class="checkout__payment-text">Google Pay</span>
                                <span class="checkout__payment-icon"><img src="/assets/img/payment_3.svg" alt=""></span>
                            </label>
                            
                            <label class="checkout__payment-method">
                                <input type="radio" name="payment-method" value="apple-pay">
                                <span class="checkout__payment-checkbox"></span>
                                <span class="checkout__payment-text">Apple Pay</span>
                                <span class="checkout__payment-icon"><img src="/assets/img/payment_4.svg" alt=""></span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="checkout__option">
                    <label class="checkout__option-label">
                        <input type="radio" name="payment" value="bank">
                        <span class="checkout__option-checkbox"></span>
                        <span class="checkout__option-text">Безналичный перевод для оптовых покупателей</span>
                    </label>
                </div>
            </div>

            <!-- Комментарий к заказу -->
            <div class="checkout__section">
                <h2 class="checkout__section-title">Комментарий к заказу</h2>
                
                <div class="checkout__comment-buttons">
                    <button class="checkout__comment-btn checkout__comment-btn--outline">Добавить открытку</button>
                    <button class="checkout__comment-btn checkout__comment-btn--filled">Упаковать в пленку</button>
                    <button class="checkout__comment-btn checkout__comment-btn--outline">Подготовить заранее</button>
                </div>
                
                <textarea class="checkout__comment-textarea" placeholder="Ваш комментарий"></textarea>
            </div>

            <!-- Получатель -->
            <div class="checkout__section">
                <h2 class="checkout__section-title">Получатель</h2>
                
                <div class="checkout__recipient-options">
                    <label class="checkout__recipient-option">
                        <input type="radio" name="recipient" value="self" checked>
                        <span class="checkout__recipient-checkbox"></span>
                        <span class="checkout__recipient-text">Я сам</span>
                    </label>
                    
                    <label class="checkout__recipient-option">
                        <input type="radio" name="recipient" value="other">
                        <span class="checkout__recipient-checkbox"></span>
                        <span class="checkout__recipient-text">Другой</span>
                    </label>
                </div>

                <!-- Поля для другого получателя -->
                <div class="checkout__recipient-details" id="recipientDetails" style="display: none;">
                    <div class="checkout__recipient-fields">
                        <div class="checkout__recipient-field">
                            <input type="text" class="checkout__recipient-input" placeholder="Имя">
                        </div>
                        <div class="checkout__recipient-field">
                            <input type="text" class="checkout__recipient-input" placeholder="Телефон">
                        </div>
                        <div class="checkout__recipient-field">
                            <input type="text" class="checkout__recipient-input" placeholder="Фамилия">
                        </div>
                        <div class="checkout__recipient-field">
                            <input type="email" class="checkout__recipient-input" placeholder="Почта (необязательно)">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Кнопка подтверждения -->
            <button class="checkout__confirm-btn">Заказ подтверждаю</button>
        </div>
    </main>

    <!-- Попап промокода -->
    <div class="promo-popup" id="promoPopup">
        <div class="promo-popup__overlay"></div>
        <div class="promo-popup__content">
            <div class="promo-popup__header">
                <h2 class="promo-popup__title">Введите промокод</h2>
                <button class="promo-popup__close" id="closePromoPopup">×</button>
            </div>
            
            <div class="promo-popup__body">
                <input type="text" class="promo-popup__input" id="promoInput" placeholder="Введите промокод">
                <div class="promo-popup__message" id="promoMessage"></div>
            </div>
            
            <div class="promo-popup__footer">
                <button class="promo-popup__cancel-btn" id="cancelPromo">Отмена</button>
                <button class="promo-popup__apply-btn" id="applyPromo">Применить</button>
            </div>
        </div>
    </div>

    <!-- Попап карты -->
    <div class="map-popup" id="mapPopup">
        <div class="map-popup__overlay"></div>
        <div class="map-popup__content">
            <div class="map-popup__header">
                <h2 class="map-popup__title">Выберите адрес на карте</h2>
                <button class="map-popup__close" id="closeMapPopup">×</button>
            </div>
            
            <div class="map-popup__body">
                <div class="map-popup__map" id="yandexMap"></div>
                <div class="map-popup__address">
                    <input type="text" class="map-popup__input" id="mapAddressInput" value="Астана. Проспект Улы Дала 45/1">
                </div>
            </div>
            
            <div class="map-popup__footer">
                <button class="map-popup__cancel-btn" id="cancelMap">Отмена</button>
                <button class="map-popup__confirm-btn" id="confirmMap">Подтвердить</button>
            </div>
        </div>
    </div>

    <!-- Попап успешного заказа -->
    <div class="success-popup" id="successPopup">
        <div class="success-popup__overlay"></div>
        <div class="success-popup__content">
            <button class="success-popup__close" id="closeSuccessPopup">×</button>
            <h2 class="success-popup__title">Ваш заказ принят</h2>
            <p class="success-popup__order-number">Номер заказа 123456</p>
            <div class="success-popup__icon">
                <svg width="90" height="90" viewBox="0 0 90 90" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M7.5 46.3333L32.5 72L82.5 17" stroke="#EBE3D0" stroke-width="8" stroke-linecap="round" stroke-linejoin="round" />
                  </svg>
            </div>
            <button class="success-popup__btn" id="continueShopping">Продолжить покупки</button>
        </div>
    </div>

    <script>
        // Управление радиокнопками доставки
        const deliveryRadios = document.querySelectorAll('input[name="delivery"]');
        const pickupDetails = document.getElementById('pickupDetails');
        const deliveryDetails = document.getElementById('deliveryDetails');
        
        deliveryRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                // Обновляем визуальное состояние всех радиокнопок доставки
                deliveryRadios.forEach(r => {
                    const label = r.closest('.checkout__option-label');
                    const option = r.closest('.checkout__option');
                    if (r.checked) {
                        label.classList.add('checked');
                        option.classList.add('checkout__option--active');
                    } else {
                        label.classList.remove('checked');
                        option.classList.remove('checkout__option--active');
                    }
                });

                // Показываем/скрываем детали в зависимости от выбранной опции
                if (this.value === 'pickup') {
                    pickupDetails.style.display = 'flex';
                    deliveryDetails.style.display = 'none';
                } else if (this.value === 'delivery') {
                    pickupDetails.style.display = 'none';
                    deliveryDetails.style.display = 'flex';
                }
            });
        });

        // Управление радиокнопками оплаты
        const paymentRadios = document.querySelectorAll('input[name="payment"]');
        const paymentNowDetails = document.getElementById('paymentNowDetails');
        
        paymentRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                // Обновляем визуальное состояние всех радиокнопок оплаты
                paymentRadios.forEach(r => {
                    const label = r.closest('.checkout__option-label');
                    const option = r.closest('.checkout__option');
                    if (r.checked) {
                        label.classList.add('checked');
                        option.classList.add('checkout__option--active');
                    } else {
                        label.classList.remove('checked');
                        option.classList.remove('checkout__option--active');
                    }
                });

                // Показываем/скрываем подварианты для "Оплатить сейчас"
                if (this.value === 'now') {
                    paymentNowDetails.style.display = 'block';
                } else {
                    paymentNowDetails.style.display = 'none';
                }
            });
        });

        // Управление подвариантами оплаты
        const paymentMethodRadios = document.querySelectorAll('input[name="payment-method"]');
        paymentMethodRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                // Обновляем визуальное состояние всех радиокнопок методов оплаты
                paymentMethodRadios.forEach(r => {
                    const label = r.closest('.checkout__payment-method');
                    if (r.checked) {
                        label.classList.add('checked');
                    } else {
                        label.classList.remove('checked');
                    }
                });
            });
        });

        // Управление радиокнопками получателя
        const recipientRadios = document.querySelectorAll('input[name="recipient"]');
        const recipientDetails = document.getElementById('recipientDetails');
        
        recipientRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                // Обновляем визуальное состояние всех радиокнопок получателя
                recipientRadios.forEach(r => {
                    const option = r.closest('.checkout__recipient-option');
                    if (r.checked) {
                        option.classList.add('checked');
                    } else {
                        option.classList.remove('checked');
                    }
                });

                // Показываем/скрываем поля для другого получателя
                if (this.value === 'other') {
                    recipientDetails.style.display = 'block';
                } else {
                    recipientDetails.style.display = 'none';
                }
            });
        });

        // Управление кнопками комментариев
        const commentBtns = document.querySelectorAll('.checkout__comment-btn');
        commentBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                // Переключаем состояние кнопки
                if (this.classList.contains('checkout__comment-btn--filled')) {
                    this.classList.remove('checkout__comment-btn--filled');
                    this.classList.add('checkout__comment-btn--outline');
                } else {
                    this.classList.remove('checkout__comment-btn--outline');
                    this.classList.add('checkout__comment-btn--filled');
                }
            });
        });

        // Кнопка подтверждения заказа
        const confirmBtn = document.querySelector('.checkout__confirm-btn');
        confirmBtn.addEventListener('click', function() {
            // Генерируем случайный номер заказа
            const orderNumber = Math.floor(Math.random() * 900000) + 100000;
            document.querySelector('.success-popup__order-number').textContent = `Номер заказа ${orderNumber}`;
            
            // Показываем попап успеха
            document.getElementById('successPopup').classList.add('success-popup--active');
            document.body.style.overflow = 'hidden';
        });

        // Функционал промокода
        const promoPopup = document.getElementById('promoPopup');
        const openPromoBtn = document.getElementById('openPromoPopup');
        const closePromoBtn = document.getElementById('closePromoPopup');
        const cancelPromoBtn = document.getElementById('cancelPromo');
        const applyPromoBtn = document.getElementById('applyPromo');
        const promoInput = document.getElementById('promoInput');
        const promoMessage = document.getElementById('promoMessage');
        const totalPriceElement = document.getElementById('totalPrice');
        const promoLink = document.querySelector('.checkout__promo-link');

        // База промокодов
        const promoCodes = {
            'SALE10': { discount: 10, type: 'percent' },
            'SALE20': { discount: 20, type: 'percent' },
            'FIXED1000': { discount: 1000, type: 'fixed' },
            'FIXED5000': { discount: 5000, type: 'fixed' }
        };

        let originalTotal = 377200; // Исходная сумма
        let currentTotal = originalTotal;
        let appliedPromo = null;

        // Открытие попапа промокода
        openPromoBtn.addEventListener('click', function(e) {
            e.preventDefault();
            promoPopup.classList.add('promo-popup--active');
            document.body.style.overflow = 'hidden';
            promoInput.focus();
        });

        // Закрытие попапа промокода
        function closePromoPopup() {
            promoPopup.classList.remove('promo-popup--active');
            document.body.style.overflow = '';
            promoInput.value = '';
            promoMessage.textContent = '';
        }

        closePromoBtn.addEventListener('click', closePromoPopup);
        cancelPromoBtn.addEventListener('click', closePromoPopup);

        // Закрытие по клику на overlay
        promoPopup.querySelector('.promo-popup__overlay').addEventListener('click', closePromoPopup);

        // Применение промокода
        applyPromoBtn.addEventListener('click', function() {
            const promoCode = promoInput.value.trim().toUpperCase();
            
            if (!promoCode) {
                promoMessage.textContent = 'Введите промокод';
                promoMessage.className = 'promo-popup__message promo-popup__message--error';
                return;
            }

            if (promoCodes[promoCode]) {
                const promo = promoCodes[promoCode];
                let discount = 0;
                
                if (promo.type === 'percent') {
                    discount = Math.round(originalTotal * promo.discount / 100);
                } else if (promo.type === 'fixed') {
                    discount = promo.discount;
                }

                currentTotal = Math.max(0, originalTotal - discount);
                appliedPromo = { code: promoCode, discount: discount, type: promo.type };
                
                updateTotalDisplay();
                updatePromoLink();
                
                promoMessage.textContent = `Промокод "${promoCode}" применен! Скидка: ${discount.toLocaleString()} KZT`;
                promoMessage.className = 'promo-popup__message promo-popup__message--success';
                
                setTimeout(closePromoPopup, 2000);
            } else {
                promoMessage.textContent = 'Промокод не найден';
                promoMessage.className = 'promo-popup__message promo-popup__message--error';
            }
        });

        // Применение промокода по Enter
        promoInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                applyPromoBtn.click();
            }
        });

        // Обновление отображения общей суммы
        function updateTotalDisplay() {
            totalPriceElement.textContent = currentTotal.toLocaleString() + ' KZT';
        }

        // Обновление ссылки промокода
        function updatePromoLink() {
            if (appliedPromo) {
                promoLink.textContent = `Промокод: ${appliedPromo.code} (-${appliedPromo.discount.toLocaleString()} KZT)`;
                promoLink.style.color = '#ff6565';
            } else {
                promoLink.textContent = 'Промокод +';
                promoLink.style.color = '#7e5c45';
            }
        }

        // Удаление промокода при клике на ссылку (если промокод уже применен)
        promoLink.addEventListener('click', function(e) {
            if (appliedPromo) {
                e.preventDefault();
                appliedPromo = null;
                currentTotal = originalTotal;
                updateTotalDisplay();
                updatePromoLink();
            }
        });

        // Функционал попапа карты
        const mapPopup = document.getElementById('mapPopup');
        const openMapBtn = document.getElementById('openMapPopup');
        const openMapBtn2 = document.getElementById('openMapPopup2');
        const closeMapBtn = document.getElementById('closeMapPopup');
        const cancelMapBtn = document.getElementById('cancelMap');
        const confirmMapBtn = document.getElementById('confirmMap');
        const mapAddressInput = document.getElementById('mapAddressInput');
        const addressInputs = document.querySelectorAll('.checkout__option-input');

        let yandexMap = null;
        let mapPlacemark = null;

        // Инициализация Яндекс карты
        function initYandexMap() {
            if (typeof ymaps === 'undefined') {
                console.error('Yandex Maps API не загружен');
                return;
            }

            ymaps.ready(function () {
                // Координаты Астаны (долгота, широта)
                const astanaCoords = [71.4307, 51.1801];
                
                yandexMap = new ymaps.Map('yandexMap', {
                    center: astanaCoords,
                    zoom: 6,
                    controls: ['zoomControl', 'fullscreenControl'],
                    restrictMapArea: [
                        [46.0, 40.5], // Юго-запад (долгота, широта)
                        [87.0, 55.5]  // Северо-восток (долгота, широта)
                    ]
                });

                // Создаем метку
                mapPlacemark = new ymaps.Placemark(astanaCoords, {
                    balloonContent: 'Выбранный адрес'
                }, {
                    draggable: true
                });

                yandexMap.geoObjects.add(mapPlacemark);

                // Добавляем точки самовывоза
                const pickupPoints = [
                    {
                        coords: [71.4307, 51.1801], // Астана (долгота, широта)
                        title: 'Астана. Проспект Улы Дала 45/1',
                        time: 'с 9 до 22'
                    },
                    {
                        coords: [76.9126, 43.2220], // Алматы (долгота, широта)
                        title: 'Алматы. ул. Абая 150',
                        time: 'с 9 до 22'
                    },
                    {
                        coords: [69.5950, 42.8746], // Шымкент (долгота, широта)
                        title: 'Шымкент. ул. Байтурсынова 12',
                        time: 'с 9 до 22'
                    }
                ];

                pickupPoints.forEach(point => {
                    const placemark = new ymaps.Placemark(point.coords, {
                        balloonContent: `<div><strong>${point.title}</strong><br>Время работы: ${point.time}</div>`
                    }, {
                        preset: 'islands#redDotIcon',
                        iconColor: '#ff6565'
                    });
                    yandexMap.geoObjects.add(placemark);
                });

                // Обработчик клика по карте
                yandexMap.events.add('click', function (e) {
                    const coords = e.get('coords');
                    
                    // Удаляем старую метку
                    yandexMap.geoObjects.remove(mapPlacemark);
                    
                    // Создаем новую метку
                    mapPlacemark = new ymaps.Placemark(coords, {
                        balloonContent: 'Выбранный адрес'
                    }, {
                        draggable: true
                    });
                    
                    yandexMap.geoObjects.add(mapPlacemark);
                    
                    // Получаем адрес по координатам
                    getAddressByCoords(coords);
                });

                // Обработчик перетаскивания метки
                mapPlacemark.events.add('dragend', function () {
                    const coords = mapPlacemark.geometry.getCoordinates();
                    getAddressByCoords(coords);
                });
            });
        }

        // Получение адреса по координатам
        function getAddressByCoords(coords) {
            ymaps.geocode(coords).then(function (res) {
                const firstGeoObject = res.geoObjects.get(0);
                const address = firstGeoObject.getAddressLine();
                mapAddressInput.value = address;
            });
        }

        // Открытие попапа карты
        function openMapPopup() {
            mapPopup.classList.add('map-popup--active');
            document.body.style.overflow = 'hidden';
            
            // Инициализируем карту при первом открытии
            if (!yandexMap) {
                setTimeout(initYandexMap, 100);
            }
        }

        openMapBtn.addEventListener('click', function(e) {
            e.preventDefault();
            openMapPopup();
        });

        openMapBtn2.addEventListener('click', function(e) {
            e.preventDefault();
            openMapPopup();
        });

        // Закрытие попапа карты
        function closeMapPopup() {
            mapPopup.classList.remove('map-popup--active');
            document.body.style.overflow = '';
        }

        closeMapBtn.addEventListener('click', closeMapPopup);
        cancelMapBtn.addEventListener('click', closeMapPopup);

        // Закрытие по клику на overlay
        mapPopup.querySelector('.map-popup__overlay').addEventListener('click', closeMapPopup);

        // Подтверждение выбора адреса
        confirmMapBtn.addEventListener('click', function() {
            const selectedAddress = mapAddressInput.value;
            
            // Обновляем все поля адреса
            addressInputs.forEach(input => {
                input.value = selectedAddress;
            });
            
            closeMapPopup();
        });

        // Функционал попапа успеха
        const successPopup = document.getElementById('successPopup');
        const closeSuccessBtn = document.getElementById('closeSuccessPopup');
        const continueShoppingBtn = document.getElementById('continueShopping');

        // Закрытие попапа успеха
        function closeSuccessPopup() {
            successPopup.classList.remove('success-popup--active');
            document.body.style.overflow = '';
        }

        closeSuccessBtn.addEventListener('click', closeSuccessPopup);
        continueShoppingBtn.addEventListener('click', function() {
            closeSuccessPopup();
            // Можно добавить редирект на главную или каталог
            // window.location.href = 'index.html';
        });

        // Закрытие по клику на overlay
        successPopup.querySelector('.success-popup__overlay').addEventListener('click', closeSuccessPopup);

        // Функционал мобильного меню
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        const mobileMenu = document.getElementById('mobileMenu');
        const mobileMenuClose = document.getElementById('mobileMenuClose');

        // Открытие мобильного меню
        mobileMenuToggle.addEventListener('click', function() {
            mobileMenu.classList.add('mobile-menu--active');
            document.body.style.overflow = 'hidden';
        });

        // Закрытие мобильного меню
        function closeMobileMenu() {
            mobileMenu.classList.remove('mobile-menu--active');
            document.body.style.overflow = '';
        }

        mobileMenuClose.addEventListener('click', closeMobileMenu);
        mobileMenu.querySelector('.mobile-menu__overlay').addEventListener('click', closeMobileMenu);

        // Функционал счетчика корзины
        const cartCount = document.getElementById('cartCount');
        const mobileCartCount = document.getElementById('mobileCartCount');
        
        // Функция обновления счетчика корзины
        function updateCartCount() {
            // Подсчитываем количество товаров в заказе
            const orderItems = document.querySelectorAll('.checkout__item');
            const totalItems = orderItems.length;
            
            cartCount.textContent = totalItems;
            mobileCartCount.textContent = totalItems;
        }
        
        // Инициализация счетчика
        updateCartCount();

        // Инициализация состояния радиокнопок
        deliveryRadios.forEach(radio => {
            if (radio.checked) {
                radio.closest('.checkout__option-label').classList.add('checked');
                radio.closest('.checkout__option').classList.add('checkout__option--active');
            }
        });

        paymentRadios.forEach(radio => {
            if (radio.checked) {
                radio.closest('.checkout__option-label').classList.add('checked');
                radio.closest('.checkout__option').classList.add('checkout__option--active');
            }
        });

        recipientRadios.forEach(radio => {
            if (radio.checked) {
                radio.closest('.checkout__recipient-option').classList.add('checked');
            }
        });
    </script>
</body>
</html>
